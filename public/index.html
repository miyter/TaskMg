<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無料タスク管理ツール</title>
    <!-- Tailwind CSSのインポート (仕様書に基づく) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 適切なフォントを設定 */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">My Task Manager</h1>
            <!-- 認証ボタンのコンテナ -->
            <div id="auth-ui">
                <!-- ログアウト状態の時に表示 -->
                <button id="google-login-btn" onclick="signInWithGoogle()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Googleでサインイン
                </button>
                <!-- ログイン状態の時に表示 -->
                <div id="user-info" class="hidden flex items-center space-x-2">
                    <span id="user-display-name" class="text-sm text-gray-600"></span>
                    <button onclick="signOut(auth)" 
                            class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-lg transition duration-150">
                        ログアウト
                    </button>
                </div>
            </div>
        </header>

        <!-- タスク入力フォーム -->
        <div id="task-input-section" class="mb-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">新しいタスクを追加</h2>
            <div class="flex space-x-3">
                <input type="text" id="task-title-input" placeholder="タスクのタイトルを入力..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
                <button onclick="handleAddTask()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150">
                    追加
                </button>
            </div>
        </div>

        <!-- タスク一覧 -->
        <div id="task-list-container">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">タスク一覧</h2>
            <ul id="task-list" class="space-y-3">
                <!-- ここにタスクがリアルタイムで表示されます -->
                <li class="p-4 bg-gray-100 rounded-lg text-gray-500 italic">タスクがありません。ログインして最初のタスクを追加してください。</li>
            </ul>
        </div>
    </div>

    <!-- ここにFirebaseの初期化と関数を記述します -->
    <script type="module">
        // --- 1. Firebase SDK のインポートと初期設定 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signOut, 
            signInWithCustomToken,
            GoogleAuthProvider, 
            // 認証ポップアップ/リダイレクト関連をインポート
            signInWithRedirect, // ★リダイレクト認証のために追加
            getRedirectResult // ★リダイレクト結果取得のために追加
        } 
        from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            // ログレベル設定を追加
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ログレベルをデバッグに設定 (Firestoreの動作確認に便利です)
        setLogLevel('debug');

        // 環境変数から設定を取得 (Canvas環境での必須手順)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebaseアプリの初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Google認証プロバイダーの定義
        const googleProvider = new GoogleAuthProvider();

        // ログイン状態とユーザーIDを保持するための変数
        let userId = null; 
        
        // UI要素の参照
        const googleLoginBtn = document.getElementById('google-login-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userDisplayNameSpan = document.getElementById('user-display-name');
        const taskList = document.getElementById('task-list');
        const taskTitleInput = document.getElementById('task-title-input');


        // --- 2. 認証処理 ---
        
        // Google認証リダイレクトを開始する関数 (ポップアップからリダイレクトに変更)
        window.signInWithGoogle = async () => {
            try {
                // signInWithPopup の代わりに signInWithRedirect を使用
                // この操作でブラウザがGoogleの認証ページにリダイレクトされます
                await signInWithRedirect(auth, googleProvider);
                // リダイレクトにより、この行以降は実行されない
            } catch (error) {
                // エラー処理
                console.error("Google認証開始中にエラーが発生しました:", error.code, error.message);
                // エラーメッセージをユーザーに分かりやすく表示する処理を入れると良い
            }
        }

        // 認証処理（Canvas環境向け）
        async function initializeAuth() {
            try {
                // 1. リダイレクト結果の確認
                // 認証ページから戻ってきた場合、ここで結果を取得する
                const result = await getRedirectResult(auth);
                if (result) {
                    // Googleアカウントでサインインに成功
                    console.log("Googleリダイレクト認証でログインしました:", result.user.displayName);
                }

                // 2. 初期トークンまたは匿名認証でのログイン
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!auth.currentUser) { 
                    // リダイレクト認証の結果、まだログインしていなければ匿名認証を試みる
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("初期認証またはリダイレクト結果取得中にエラーが発生しました:", error);
                
                // エラーコードに応じて特定の処理を行うことも可能
                if (error.code === 'auth/account-exists-with-different-credential') {
                    // 以前の認証方法と競合した場合などの処理
                }
            }
        }

        // 認証状態の監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ログイン済み
                userId = user.uid;
                // Google認証の場合、displayNameも取得可能
                const displayName = user.displayName || `UID: ${userId.substring(0, 8)}...`; 
                console.log("ユーザーがログインしました。UID:", userId);
                
                // UIの更新: ログイン状態
                googleLoginBtn.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                userDisplayNameSpan.textContent = `ようこそ、${displayName} さん`; // ユーザー名を表示
                
                // 認証完了後にタスクのリアルタイムリスナーを開始
                listenToTasks(); 

            } else {
                // ログアウトまたは未ログイン
                userId = null;
                console.log("ユーザーはログアウトしています。");

                // UIの更新: ログアウト状態
                googleLoginBtn.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                taskList.innerHTML = '<li class="p-4 bg-gray-100 rounded-lg text-gray-500 italic">タスクがありません。ログインして最初のタスクを追加してください。</li>';
            }
        });

        // 認証をキックオフ
        initializeAuth();


        // --- 3. Firestore データ操作関数 ---

        /**
         * 認証済みユーザーのタスクコレクションへの参照を取得
         */
        function getTaskCollectionRef(currentUserId) {
            const path = `/artifacts/${appId}/users/${currentUserId}/tasks`;
            return collection(db, path);
        }

        // データの追加
        async function addTask(taskTitle) {
            if (!userId || !taskTitle.trim()) {
                console.warn("ユーザーが認証されていないか、タイトルが空です。");
                return;
            }
            try {
                await addDoc(getTaskCollectionRef(userId), {
                    title: taskTitle.trim(),
                    status: "todo",
                    createdAt: new Date(),
                    ownerId: userId 
                });
                taskTitleInput.value = ''; // 入力欄をクリア
                console.log("タスクが追加されました！");
            } catch (e) {
                console.error("タスク追加中にエラー:", e);
            }
        }

        // UIイベントハンドラ
        window.handleAddTask = () => {
            const title = taskTitleInput.value;
            addTask(title);
        };


        // データのリアルタイムな読み込みとUI反映
        function listenToTasks() {
            if (!userId) return;

            const q = query(getTaskCollectionRef(userId));
            
            // リアルタイムリスナーを設定
            onSnapshot(q, (snapshot) => {
                // リアルタイム更新されたタスクリスト全体を再構築
                taskList.innerHTML = '';
                if (snapshot.empty) {
                     taskList.innerHTML = '<li class="p-4 bg-gray-100 rounded-lg text-gray-500 italic">タスクがありません。追加してください。</li>';
                     return;
                }

                snapshot.docs.forEach((doc) => {
                    const task = doc.data();
                    const taskId = doc.id; // ドキュメントIDを取得
                    const taskElement = document.createElement('li');
                    
                    // タスクの見た目を少し調整
                    taskElement.className = 'p-4 border-l-4 border-blue-500 bg-white rounded-lg shadow flex justify-between items-center transition duration-150 hover:shadow-lg';
                    taskElement.setAttribute('data-id', taskId);
                    
                    taskElement.innerHTML = `
                        <span class="text-gray-800">${task.title}</span>
                        <span class="text-xs text-gray-400">(${task.status})</span>
                    `;
                    taskList.appendChild(taskElement);
                });
                console.log("タスクリストを更新しました。");

            }, (error) => {
                console.error("タスクのリアルタイム更新エラー:", error);
            });
        }

    </script>
</body>
</html>