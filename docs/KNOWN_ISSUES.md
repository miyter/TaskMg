# 既知の課題と改善候補 (Antigravity 作業用整理版)

このドキュメントは、コードレビューで指摘された課題を、開発者が着手しやすいように「ワークパッケージ」として再編したものです。

**最終更新**: 2025-12-30
**ステータス**: 🟡 要対応多し

---

## � ワークパッケージ 1: データ層・インフラ (基盤の安定化)
最優先で修正すべき、メモリリークやデータ不整合のリスク、およびパフォーマンスの根幹に関わる課題です。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| ~~**グローバル状態の管理**~~ | `_cachedTasksMap` 等がモジュールスコープで永続化されている | ✅ `resetTaskCache` を実装し、メモリ解放可能にした (Done) |
| **購読管理の徹底** | ワークスペース切替時に古い Firestore リスナーが残存するリスク | `unsubscribe` を確実に実行し、有効な購読を ID で厳密に管理する |
| ~~**データ整形の透明化**~~ | `deserializeTask` でのサイレントな不正データ補完 | ✅ 警告ログを追加 (Done) |
| ~~**スキーマの同期**~~ | `order` フィールド等が実装にあるが `schema.ts` に未定義 | ✅ `TaskSchema` に `order` 追加 (Done) |
| ~~**非同期原子性の確保**~~ | `forEach` 内の非同期処理による順序・状態不整合 | ✅ `useAppDnD` 等での `forEach` を `Promise.all` に修正 (Done) |
| **Optimistic UI** | Firestore 書き込み後の反映ラグ (onSnapshot 待ち) | ストア側での先行的なキャッシュ更新を実装し、体感速度を向上させる |
| **キャッシュ同期の疎結合** | `getProjects()` が購読未完了時に単に空を返す | ローディング状態を統合管理し、UI 側での不整合表示を防ぐ |

## 📦 ワークパッケージ 2: 共通 UI 基盤 (シェルの洗練)
アプリケーション全体を包むレイアウト、サイドバー、モーダル管理の構造的欠陥を修正します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| ~~**モーダルマウント管理**~~ | `ModalManager` ですべてのモーダルが常時マウントされている | ✅ `activeModal` に基づく条件付きレンダーに修正 (Done) |
| ~~**モーダル機能の集約**~~ | 背景クリック/Esc閉じ/スクロールロックが個別実装 | ✅ `Modal` コンポーネントにスクロールロックを追加し集約 (Done) |
| ~~**高さの継承と破綻**~~ | `AppLayout` の `h-full` がルートの高さに依存している | ✅ `index.css` で `html, body { height: 100% }` を追加 (Done) |
| ~~**サイドバー・リサイザー**~~ | ハンドルが細すぎて操作不能、および PC での発見性が低い | ✅ ヒット領域を `w-2` に拡大 (Done) |
| ~~**サイドバーのレスポンシブ**~~ | 狭い幅でのロゴ溢れ、およびモバイル初期状態の不整合 | ✅ モバイルでは背景を透過させずパフォーマンス確保し、閉じるボタンを制御 (Done) |
| ~~**システムバーの整理**~~ | サイドバー常時表示時もトグルボタンが出る (Desktop) | ✅ サイドバー開放時はトグルを非表示にし、サイドバー内の閉じるボタンを有効化 (Done) |
| ~~**パフォーマンスの最適化**~~ | `backdrop-blur` の重さ、および `React.memo` の非効率な比較 | ✅ モバイルでの Blur 無効化 (Done) |

## 📦 ワークパッケージ 3: フォームとアクセシビリティ (警告解消と操作性)
コンソール警告の原因となっている ID/Label の欠落、およびキーボード/スクリーンリーダー対応を改善します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| ~~**フォーム ID の欠落**~~ | `input` 等に ID/Label がなく、アクセシビリティ低下 | ✅ ID付与、`aria-label` 追加で解消 (Done) |
| ~~**操作の一貫性**~~ | `InlineTaskInput` 等が外クリックでキャンセルできない | ✅ `useClickOutside` ロジックを実装し、外クリックで閉じるよう修正 (Done) |
| ~~**検索入力の UX**~~ | 検索の即時発火によるちらつき、およびクリア手段の欠如 | ✅ Debounce とクリアボタンを実装 (Done) |
| ~~**モバイル操作の配慮**~~ | スターボタンが Hover 依存で不可視、およびキーボードによる隠蔽 | ✅ モバイル (`md:hidden` 等) では常時表示し、タップ操作性を確保 (Done) |
| ~~**情報のアクセシビリティ**~~ | アイコンのみのボタンにラベルがない | ✅ 主要なボタンに `aria-label` を網羅的に追加 (Done) |

## 📦 ワークパッケージ 4: タスク・検索ロジック (コア機能の精度)
検索エンジン、フィルタ解析、およびタスク一覧の表示ロジックを修正します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| ~~**フィルタ解析の脆弱性**~~ | スペースを含む値 (project:"My Proj") 等の解析に失敗する | ✅ 正規表現を修正し引用符処理を強化 (Done) |
| ~~**検索エンジンのバグ**~~ | `important` フィルタが `isImportant` フラグと連動していない | ✅ `status` から `isImportant` フラグを分離し、独立して判定するよう修正 (Done) |
| ~~**検索条件の緩和**~~ | キーワード検索が常に AND で、ヒット率が低すぎる | ✅ OR キーワードによる条件分岐を実装 (Done) |
| ~~**日付比較の不確実性**~~ | オブジェクトの参照比較 (`===`) による誤判定 | ✅ `isSameDay` および Dateオブジェクトの大小比較で実装済み (Verified) |
| ~~**重要度判定の競合**~~ | `overdue` 判定が完了タスク非表示設定と競合する | ✅ `overdue` は未完了タスクを対象とする仕様で正当 (Verified) |
| ~~**動的な情報量調整**~~ | UI 密度設定に関わらずタスクの行数制限が固定 | ✅ CSS変数 `--task-line-clamp` を導入し、密度に応じて可変に修正 (Done) |

## 📦 ワークパッケージ 5: サブアプリと整合性 (Dashboard, Wiki, Wizard)
各機能モジュールの独自実装を共通基盤に寄せ、一貫性を確保します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| ~~**レイアウトの乖離**~~ | Wiki だけ幅が広い、または AppLayout と幅制限が干渉する | ✅ `AppLayout` 準拠の `h-full` 構成に統一 (Done) |
| ~~**機能の未実装**~~ | Wizard 完了時の Firestore 保存、および Dashboard の実データ反映 | ✅ `TargetSchema` および `target-store` を実装し、Wizard完了時に保存 (Done) |
| ~~**データの構造化**~~ | Wizard の `stepData` がキー固定で保守性が低い | ✅ `config` に `key` を追加し、動的かつ意味のあるキー管理へ移行 (Done) |
| ~~**コンポーネントの再利用**~~ | Wiki モーダルが `ModalManager` 非経由で独自実装されている | ✅ `ModalManager` に統合し、`Modal` コンポーネントを利用 (Done) |

---

## 🟢 優先度: 低 (将来的な改善)
- **ストア統合**: `store/` 配下のファイル構成の整理 (バレルファイルの導入)
- **エラーログ**: Sentry 等によるクライアントサイド・エラー追跡の導入
- **テストカバレッジ**: `search.ts`, `filter-parser.ts` 等の単体テスト作成

## ✅ 対応不要
- `addTaskRaw` の id delete: 現状の実装で問題なし
- `useTasks` の userId 渡し: ストアラッパーで解決済み
- `toggleTaskStatus`: `store/index.ts` に存在確認済み
