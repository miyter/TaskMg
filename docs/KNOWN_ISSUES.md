# 既知の課題と改善候補 (Antigravity 作業用整理版)

このドキュメントは、コードレビューで指摘された課題を、開発者が着手しやすいように「ワークパッケージ」として再編したものです。

**最終更新**: 2025-12-30
**ステータス**: 🟡 要対応多し

---

## � ワークパッケージ 1: データ層・インフラ (基盤の安定化)
最優先で修正すべき、メモリリークやデータ不整合のリスク、およびパフォーマンスの根幹に関わる課題です。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| **グローバル状態の管理** | `_cachedTasksMap` 等がモジュールスコープで永続化されている | 消去可能なストア内状態へ移行し、メモリリークを防止する |
| **購読管理の徹底** | ワークスペース切替時に古い Firestore リスナーが残存するリスク | `unsubscribe` を確実に実行し、有効な購読を ID で厳密に管理する |
| **データ整形の透明化** | `deserializeTask` でのサイレントな不正データ補完 | 不正データ検知時のログ出力、または型ガードの厳格化 |
| **スキーマの同期** | `order` フィールド等が実装にあるが `schema.ts` に未定義 | スキーマを最新化し、Firestore のデータ構造と型定義を一致させる |
| **非同期原子性の確保** | `forEach` 内の非同期処理による順序・状態不整合 | `Promise.all` または逐次処理 (`for...of`) への書き換え |
| **Optimistic UI** | Firestore 書き込み後の反映ラグ (onSnapshot 待ち) | ストア側での先行的なキャッシュ更新を実装し、体感速度を向上させる |
| **キャッシュ同期の疎結合** | `getProjects()` が購読未完了時に単に空を返す | ローディング状態を統合管理し、UI 側での不整合表示を防ぐ |

## 📦 ワークパッケージ 2: 共通 UI 基盤 (シェルの洗練)
アプリケーション全体を包むレイアウト、サイドバー、モーダル管理の構造的欠陥を修正します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| **モーダルマウント管理** | `ModalManager` ですべてのモーダルが常時マウントされている | `activeModal` に基づく条件付きレンダーにリファクタリングする |
| **モーダル機能の集約** | 背景クリック/Esc閉じ/スクロールロックが個別実装 | 基盤の `Modal` コンポーネントに責務を集約し、`Portal` を利用する |
| **高さの継承と破綻** | `AppLayout` の `h-full` がルートの高さに依存している | `index.css` で `html, body { height: 100% }` を明示し、レイアウト圧縮を防ぐ |
| **サイドバー・リサイザー** | ハンドルが細すぎて操作不能、および PC での発見性が低い | ヒット領域を `w-2` に拡大し、半透明の常時表示を検討する |
| **サイドバーのレスポンシブ** | 狭い幅でのロゴ溢れ、およびモバイル初期状態の不整合 | 特定幅以下でのテキスト非表示化、およびデバイス幅に応じた初期化 |
| **システムバーの整理** | サイドバー常時表示時もトグルボタンが出る (Desktop) | `md:hidden` を適用し、各解像度に最適なヘッダーを提示する |
| **パフォーマンスの最適化** | `backdrop-blur` の重さ、および `React.memo` の非効率な比較 | モバイルでの Blur 無効化、および `JSON.stringify` を避けた浅い比較への修正 |

## 📦 ワークパッケージ 3: フォームとアクセシビリティ (警告解消と操作性)
コンソール警告の原因となっている ID/Label の欠落、およびキーボード/スクリーンリーダー対応を改善します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| **フォーム ID の欠落** | `input`, `textarea` 等に ID がなく、警告とアクセシビリティ低下 | すべての構成要素に一意の ID と `htmlFor` つき Label を付与する |
| **操作の一貫性** | `InlineTaskInput` 等が Esc や外クリックでキャンセルできない | モーダル外クリックやキーイベントを拾って、期待通りのキャンセルを実現する |
| **検索入力の UX** | 検索の即時発火によるちらつき、およびクリア手段の欠如 | `debounce` (300ms) の導入、および「×」ボタンによるリセット機能を実装 |
| **モバイル操作の配慮** | スターボタンが Hover 依存で不可視、およびキーボードによる隠蔽 | モバイルでは特定要素を常時表示し、`safe-area-inset` 等で重なりを防ぐ |
| **情報のアクセシビリティ** | アイコンのみのボタンにラベルがない、または実装中ボタンの放置 | `aria-label` の付与、および未実装機能への「準備中」明示 |

## 📦 ワークパッケージ 4: タスク・検索ロジック (コア機能の精度)
検索エンジン、フィルタ解析、およびタスク一覧の表示ロジックを修正します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| **フィルタ解析の脆弱性** | スペースを含む値 (project:"My Proj") 等の解析に失敗する | 正規表現を刷新し、引用符付きの値を正確に抽出できるようにする |
| **検索エンジンのバグ** | `important` フィルタが `isImportant` フラグと連動していない | `filterTasks` の判定ロジックを修正し、重要度検索を機能させる |
| **検索条件の緩和** | キーワード検索が常に AND で、ヒット率が低すぎる | OR 条件の許容、または部分一致ロジックの柔軟化を検討する |
| **日付比較の不確実性** | オブジェクトの参照比較 (`===`) による誤判定 | `toMillis()` またはシリアライズされた文字列での正確な値比較に変更 |
| **重要度判定の競合** | `overdue` 判定が完了タスク非表示設定と競合する | フィルタの優先順位を明確化し、意図通りの表示順・抽出を実現する |
| **動的な情報量調整** | UI 密度設定に関わらずタスクの行数制限が固定 | 密度 (Compact/Spacious) に応じて行数制限を自動変更する |

## 📦 ワークパッケージ 5: サブアプリと整合性 (Dashboard, Wiki, Wizard)
各機能モジュールの独自実装を共通基盤に寄せ、一貫性を確保します。

| 項目 | 問題の概要 | 対策の方向性 |
| :--- | :--- | :--- |
| **レイアウトの乖離** | Wiki だけ幅が広い、または AppLayout と幅制限が干渉する | コンテナの責務を `AppLayout` に集約し、サブアプリ側は `w-full` を基本とする |
| **機能の未実装** | Wizard 完了時の Firestore 保存、および Dashboard の実データ反映 | `handleFinish` 等に永続化ロジックを注入し、モックデータから脱却する |
| **データの構造化** | Wizard の `stepData` がキー固定で保守性が低い | `config` ベースの動的キー管理に移行し、TypeScript で厳密に型定義する |
| **コンポーネントの再利用** | Wiki モーダルが `ModalManager` 非経由で独自実装されている | 共通のモーダル管理システムに統合し、スタイルを統一する |

---

## 🟢 優先度: 低 (将来的な改善)
- **ストア統合**: `store/` 配下のファイル構成の整理 (バレルファイルの導入)
- **エラーログ**: Sentry 等によるクライアントサイド・エラー追跡の導入
- **テストカバレッジ**: `search.ts`, `filter-parser.ts` 等の単体テスト作成

## ✅ 対応不要
- `addTaskRaw` の id delete: 現状の実装で問題なし
- `useTasks` の userId 渡し: ストアラッパーで解決済み
- `toggleTaskStatus`: `store/index.ts` に存在確認済み
