# TaskMg 作業履歴

このドキュメントは、プロジェクトの主要な変更履歴を記録します。

---

## 2025-12-31

### UX 最適化 & 機能追加 ✅
- **DnDの即時反映 (Optimistic Update)**: プロジェクト並び替え時の操作ラグを解消するため、サーバー応答を待たずにUIを更新する楽観的UI更新を実装。
- **ローディング表示の改善**: サイドバー各所（プロジェクト、ラベル、TimeBlock）に統一されたスケルトンローダーを導入し、読み込み中の体験を向上。
- **アカウント昇格機能**: ゲストユーザーがデータを保持したまま本登録を行えるよう、設定画面にアカウント管理機能（登録・ログアウト）を追加。

### UI/UX & アクセシビリティの洗練 ✅
- **アクセシビリティ完全対応**: `LoginPage`, `SettingsModal`, `TaskDetailModal` 等の全フォームで適切な `label` 関連付けを完了。ブラウザのオートフィル機能が正常に動作するよう改善。
- **モーダルの挙動最適化**: `Modal` コンポーネントにフォーカストラップを実装し、キーボード操作時のアクセシビリティを向上。
- **入力体験の向上**: `InlineTaskInput` にて、テキスト入力中の誤操作による内容消失を防止するガード処理を追加。
- **エラー通知の刷新**: ユーザーへのフィードバックを `alert()` から `toast` 通知システムへ統合し、よりモダンな体験へ。

### コード品質・安定性向上 ✅
- **型安全性の強化**: `firebase.ts` の `@ts-nocheck` を廃止し、環境変数やグローバル設定を型安全に取得できるよう再設計。
- **ストア設計のリファクタリング**: `ProjectEditModal` や `workspace-store` の設計を見直し、コンポーネント間の疎結合化と、リロード時のデータ保持の安定性を向上。
- **ロジックの堅牢化**: OKR計算におけるゼロ除算防止、ソートロジックのフォールバック強化、リストレンダリングの安定キー採用。
- **日付処理の柔軟性**: `getStartOfWeek` で週の開始日を指定可能にし、タイムゾーンに関する実装上の注釈を追加。

---

## 2025-12-30

### リファクタリング・設計改善 ✅
- **完全 React 化**: `src/ui` 内のレガシー DOM 操作コードを全廃し、全て React コンポーネントに移行完了。
- **ディレクトリ最適化**: `src/features` に主要機能をフラットに配置し、見通しを改善。
- **workspace の Zustand 移行**: グローバル変数と localStorage の直接操作を完全に廃止し、`useWorkspaceStore` による一元管理を実現。
- **型安全性 100%**: `SortCriteria`, `SearchConfig`, `Task` スキーマなど、全域にわたる TypeScript 化と厳密な型定義。
- **ストアバレルファイルの再構成**: `store.ts` と `index.ts` の混在を解消し、`src/store/index.ts` を唯一のエントリポイントとして整理。
- **フックのリアクティブ化**: `useWorkspace` フックを Zustand と同期させ、ワークスペース切り替え時の自動再読み込みを実現。

### パフォーマンス/安定性向上 ✅
- **データ購読の高度化**: `store-raw.ts` / `projects-raw.ts` にて、`areTaskArraysIdentical` や JSON比較による不要な再レンダリングの抑制。
- **レンダリング最適化**: `TaskItem`, `ProjectItem` の `React.memo` (shallow compare) 化および計算コストの高いフィルタ処理の `useMemo` 化。
- **キャッシュの堅牢化**: projects キャッシュを `Map<string, Project[]>` 形式に変更し、ワークスペース間でのデータ混入を防止。
- **ロジックの集約**: `search.ts` の二重フィルタリングを解消し、`filterTasks` エンジンにすべての検索ロジックを集約。
- **データの正規化**: `deserializeTask` での厳密なバリデーションとデフォルト値設定により、不正データによるクラッシュを防止。
- **耐障害性の向上**: `withRetry` ユーティリティを導入し、書き込み操作に指数バックオフ再試行を適用。

### UI/UX & 機能強化 ✅
- **プレミアム・デザイン**: グラスモルフィズム、高級感のあるグラデーション、浮遊アニメーション等の適用。
- **高度な検索**: フレーズ検索 (`"fix bug"`)、接頭辞クエリ (`is:important`, `p:"Inbox"`) への対応。
- **検索UIの統合**: サイドバー内への検索バー配置と、ショートカット `/` による即時アクセス。
- **重要度（スター）の正式実装**: `isImportant` スキーマ導入、スターアイコンによる直感的なトグル機能。
- **動的ソート**: `TaskList` での作成日、期限、重要度、名前による並び替え。
- **日付表示の高度化**: `formatDateCompact` による「今日」「明日」の相対表記と、期限切れの強調表示。
- **操作性向上**: `TaskList` ヘッダーの sticky 化、完了タスク表示のトグル、空状態の刷新。

### 機能実装・不具合修正 (Work Package 完了) ✅
- **TargetDashboard 実装**: Wizard で作成した目標データを Firestore に保存し、ダッシュボードで可視化（Backward/WOOP/OKR 対応）。
- **検索ロジック改善**: キーワード検索における `OR` 条件のサポート (`"A OR B"` pattern)。
- **アクセシビリティ向上**: `InlineTaskInput` の外クリック対応、フォームラベルの完備、フォーカス管理の改善。
- **データ不整合の解消**: Wizard データの構造化 (`config` ベースのキー管理) と、日付比較ロジックの安全性検証。
- **UI/UX 改善**: サイドバー/ヘッダーのレスポンシブ挙動の最適化、モバイルでの不要なブラー削除。


---
