import{u as re,r as n,j as e,E as oe}from"./react-vendor-De2reJJN.js";import{T as le}from"./firebase-lj-RYa46.js";import{u as H,f as y,H as ne,J as ie,K as de,L as ce,M as ue,N as me,O as he,P as xe,Q as pe,a as ge,z as be,A as ye,R as ke,S as ve,T as fe,V as je,W as we,I as K,B as b,X as _e,Y as Ne,y as Ce,Z as De,_ as Ie,$ as C,g as Se}from"./main-CWFzE4NY.js";import{u as Te}from"./i18n-YbRa781D.js";import{E as Ae}from"./ErrorMessage-B0ErqnNj.js";import{M as Le}from"./Modal-BZ4FPY-m.js";import{f as Be,g as Ee,h as Oe}from"./vendor-DCNAVw4P.js";import"./dnd-WiqQl0IC.js";import"./date-fns-C4HQ7vGy.js";const m=({onClick:u,isActive:k,disabled:p,children:v,title:a})=>e.jsx("button",{type:"button",onClick:u,disabled:p,title:a,className:y("p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300",k&&"bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300",p&&"opacity-50 cursor-not-allowed"),children:v}),Me=({value:u,onChange:k,placeholder:p="Write something...",className:v,editable:a=!0})=>{const{t:i}=H(),r=re({extensions:[Be,Ee.configure({placeholder:p}),Oe.configure({openOnClick:!1,linkOnPaste:!0})],content:u,editable:a,onUpdate:({editor:o})=>{k(o.getHTML())},editorProps:{attributes:{class:y("prose prose-sm dark:prose-invert max-w-none focus:outline-none min-h-[150px] px-3 py-2","prose-p:my-1 prose-headings:my-2 prose-ul:my-1 prose-ol:my-1 prose-li:my-0",!a&&"min-h-0")}}});if(n.useEffect(()=>{if(r&&u!==r.getHTML()){if(r.getText()===""&&u==="")return;r.isEmpty&&u&&r.commands.setContent(u)}},[r,u]),!r)return null;const f=()=>{const o=r.getAttributes("link").href,c=window.prompt("URL",o);if(c!==null){if(c===""){r.chain().focus().extendMarkRange("link").unsetLink().run();return}r.chain().focus().extendMarkRange("link").setLink({href:c}).run()}};return e.jsxs("div",{className:y("border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800 transition-colors focus-within:ring-2 focus-within:ring-blue-500/50",v),children:[a&&e.jsxs("div",{className:"flex flex-wrap items-center gap-1 p-1 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-900/30",children:[e.jsx(m,{onClick:()=>r.chain().focus().toggleBold().run(),isActive:r.isActive("bold"),title:i("rich_text.bold"),children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleItalic().run(),isActive:r.isActive("italic"),title:i("rich_text.italic"),children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"}),e.jsx(m,{onClick:()=>r.chain().focus().toggleHeading({level:1}).run(),isActive:r.isActive("heading",{level:1}),title:i("rich_text.heading"),children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleBulletList().run(),isActive:r.isActive("bulletList"),title:i("rich_text.bullet_list"),children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleOrderedList().run(),isActive:r.isActive("orderedList"),title:i("rich_text.ordered_list"),children:e.jsx(ue,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleTaskList().run(),isActive:r.isActive("taskList"),title:i("rich_text.task_list"),disabled:!0,children:e.jsx(me,{className:"w-4 h-4 opacity-50"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"}),e.jsx(m,{onClick:f,isActive:r.isActive("link"),title:i("rich_text.link"),children:e.jsx(he,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleCodeBlock().run(),isActive:r.isActive("codeBlock"),title:i("rich_text.code_block"),children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>r.chain().focus().toggleBlockquote().run(),isActive:r.isActive("blockquote"),title:i("rich_text.blockquote"),children:e.jsx(pe,{className:"w-4 h-4"})})]}),e.jsx(oe,{editor:r,className:"min-h-[150px]"})]})},q={TODO:"todo"},Qe=({isOpen:u,data:k,zIndex:p,overlayClassName:v})=>{const{t:a}=H(),{closeModal:i,openModal:r}=ge(),f=!!u,o=k||null,c=!(o!=null&&o.id)||o.id.startsWith("temp-"),{projects:U}=be(),{timeBlocks:W}=ye(),{customDurations:$}=Te(),[w,B]=n.useState(""),[D,E]=n.useState(""),[_,O]=n.useState(null),[M,Q]=n.useState(q.TODO),[x,z]=n.useState(!1),[j,I]=n.useState(null),[s,S]=n.useState({type:"none",days:[]}),[T,R]=n.useState(null),[A,F]=n.useState(null),[ze,X]=n.useState(!1),[N,P]=n.useState(!1),J=n.useMemo(()=>[{value:"none",label:a("recurrence.none")},{value:"daily",label:a("recurrence.daily")},{value:"weekdays",label:a("recurrence.weekdays")},{value:"weekly",label:a("recurrence.weekly")},{value:"monthly",label:a("recurrence.monthly")}],[a]),V=n.useMemo(()=>[a("days.sun"),a("days.mon"),a("days.tue"),a("days.wed"),a("days.thu"),a("days.fri"),a("days.sat")],[a]),[Y,g]=n.useState(null);n.useEffect(()=>{var t;if(o){B(o.title||""),E(o.description||""),O(o.projectId||null),Q(o.status||q.TODO),z(!!o.isImportant),R(o.timeBlockId||null),F(o.duration||null);const l=ke(o.dueDate);I(l);const d=o.recurrence||{type:"none",days:[]};S(d),d!=null&&d.type&&d.type!=="none"&&!l&&I(ve(d));const h=!!(l||(d==null?void 0:d.type)!=="none"||o.timeBlockId||o.duration);P(h||c),X(!!((t=o.description)!=null&&t.trim()))}},[o,f]);const L=n.useCallback(async()=>{if(g(null),!w.trim()){g(a("validation.required"));return}if((s==null?void 0:s.type)==="weekly"&&(!s.days||s.days.length===0)){g(a("validation.select_days"));return}const t={title:w.trim(),description:D.trim()??null,projectId:_==="none"?null:_,status:M,isImportant:x,dueDate:j?le.fromDate(j):null,recurrence:(s==null?void 0:s.type)==="none"?null:s,timeBlockId:T??null,duration:A??void 0};try{c?await fe(t):await je(o.id,t),i()}catch(l){console.error("Failed to save task",l),g(a("validation.save_fail"))}},[w,D,_,M,x,j,s,T,A,c,o,i,a]),Z=n.useCallback(async t=>{t==null||t.preventDefault(),t==null||t.stopPropagation(),g(null),!(!(o!=null&&o.id)||c)&&r("confirmation",{title:a("delete"),message:a("modal.delete_confirm"),confirmLabel:a("delete"),variant:"danger",onConfirm:async()=>{try{await we(o.id),i()}catch(l){console.error("Failed to delete task",l),g(a("validation.delete_fail"))}}})},[o==null?void 0:o.id,c,i,r,a]),G=n.useCallback(t=>{let l=[];t==="weekly"?l=(s==null?void 0:s.days)||[]:t==="weekdays"&&(l=[1,2,3,4,5]),S({type:t,days:l})},[s==null?void 0:s.days]),ee=n.useCallback(t=>{const l=(s==null?void 0:s.days)||[],d=l.includes(t)?l.filter(h=>h!==t):[...l,t].sort((h,se)=>h-se);S({type:"weekly",days:d})},[s==null?void 0:s.days]),te=t=>{t.key==="Enter"&&!t.nativeEvent.isComposing&&(t.preventDefault(),L())},ae=t=>{(t.metaKey||t.ctrlKey)&&t.key==="Enter"&&(t.preventDefault(),L())};return f?e.jsx(Le,{isOpen:f,onClose:i,zIndex:p,size:"xl",className:"h-[95vh] sm:h-[85vh] w-full mx-2 sm:mx-auto mt-4 sm:mt-0 pb-safe",overlayClassName:v,children:e.jsxs("div",{className:"flex flex-col h-full",onKeyDown:ae,children:[e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-b border-gray-100 dark:border-gray-700 flex items-center gap-2 shrink-0",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(K,{id:"task-title",name:"title",type:"text",value:w,onChange:t=>B(t.target.value),onKeyDown:te,placeholder:a("task_detail.title_placeholder"),className:"text-base sm:text-lg font-semibold bg-transparent border-none focus:ring-0 px-0 py-0 shadow-none h-auto rounded-none",containerClassName:"gap-0",autoFocus:!0,"aria-label":a("task_detail.title_placeholder"),maxLength:15})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>z(!x),className:y("p-1.5 rounded-md transition-colors",x?"text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/30":"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"),title:a(x?"task_detail.unmark_important":"task_detail.mark_important"),"aria-label":a(x?"task_detail.unmark_important":"task_detail.mark_important"),children:e.jsx(_e,{size:16,fill:x?"currentColor":"none"})}),e.jsx(b,{variant:"ghost",size:"icon",onClick:i,className:"p-1.5 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors","aria-label":a("modal.close"),children:e.jsx(Ne,{size:16})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar",children:[e.jsx(Ae,{message:Y,className:"mb-3"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-6 h-full",children:[e.jsx("div",{className:"md:col-span-8 flex flex-col h-full min-h-[400px]",children:e.jsx(Me,{value:D,onChange:E,placeholder:a("task_detail.description_placeholder")||"詳細を追加...",className:"flex-1 flex flex-col"})}),e.jsx("div",{className:"hidden md:block col-span-1 w-px bg-gray-100 dark:bg-gray-800 h-full mx-auto"}),e.jsxs("div",{className:"md:col-span-3 space-y-5 pt-1 overflow-y-auto no-scrollbar",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{type:"button",onClick:()=>P(!N),"aria-expanded":N,className:"w-full flex items-center justify-between group text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800 hover:text-blue-500 transition-colors focus:outline-none focus:border-blue-500",children:[e.jsx("span",{className:"flex items-center gap-2",children:a("task_detail.schedule_label")}),e.jsx(Ce,{className:y("w-3 h-3 transition-transform duration-200",N?"rotate-180":"")})]}),N&&e.jsxs("div",{className:"space-y-3 px-1 animate-in slide-in-from-top-1 fade-in duration-200",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("label",{htmlFor:"task-due-date",className:"text-xs text-gray-500 mb-1 block",children:a("task_detail.due_date_label")}),e.jsx("div",{className:"relative cursor-pointer",onClick:()=>{var l;const t=document.getElementById("task-due-date");(l=t==null?void 0:t.showPicker)==null||l.call(t)},children:e.jsx(K,{type:"date",id:"task-due-date",value:j?De(j):"",onChange:t=>I(Ie(t.target.value)),className:"cursor-pointer bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto w-full"})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"task-recurrence",className:"text-xs text-gray-500 mb-1 block",children:a("task_detail.recurrence_label")}),e.jsx(C,{id:"task-recurrence",value:(s==null?void 0:s.type)||"none",onChange:t=>G(t.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",options:J})]}),((s==null?void 0:s.type)==="weekly"||(s==null?void 0:s.type)==="weekdays")&&e.jsx("div",{className:"pt-2 animate-in fade-in slide-in-from-top-1 duration-200",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:V.map((t,l)=>{var h;const d=(h=s.days)==null?void 0:h.includes(l);return e.jsx(b,{type:"button",variant:d?"primary":"outline",size:"icon",onClick:()=>ee(l),className:y("w-7 h-7 text-xs rounded-full p-0 border",!d&&"bg-transparent text-gray-500 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:t},l)})})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"task-timeblock",className:"text-xs text-gray-500 mb-1 block",children:a("task_detail.time_block_label")}),e.jsxs(C,{id:"task-timeblock",value:T||"",onChange:t=>R(t.target.value||null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:a("task_detail.time_block_unspecified")}),W.map(t=>e.jsxs("option",{value:t.id,children:[t.start," - ",t.end]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"task-duration",className:"text-xs text-gray-500 mb-1 block",children:a("task_detail.duration_label")}),e.jsxs(C,{id:"task-duration",value:A||"",onChange:t=>F(t.target.value?parseInt(t.target.value,10):null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:a("task_detail.duration_none")}),$.map(t=>e.jsxs("option",{value:t,children:[t," ",a("task_detail.duration_unit")]},t))]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800",children:a("task_detail.project_label")}),e.jsx("div",{className:"px-1",children:e.jsxs(C,{id:"task-project",value:_||"none",onChange:t=>O(t.target.value==="none"?null:t.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",containerClassName:"gap-2",children:[e.jsx("option",{value:"none",children:a("task_detail.project_none")}),U.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})})]})]})]})]}),e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center shrink-0",children:[c?e.jsx("div",{}):e.jsx(b,{variant:"ghost",size:"sm",onClick:Z,className:"text-gray-400 hover:text-red-500 font-medium px-2",leftIcon:e.jsx(Se,{size:14}),children:a("task_detail.delete_button")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:i,className:"font-medium",children:a("modal.cancel")}),e.jsx(b,{variant:"primary",size:"sm",onClick:L,children:a(c?"modal.create":"modal.save")})]})]})]})}):null};export{Qe as TaskDetailModal};
