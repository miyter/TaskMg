import{R as M,i as re,d as oe,e as le,u as ne,r as n,j as e,E as ie}from"./react-vendor-BT7r1O85.js";import{T as de}from"./firebase-D5EeALLO.js";import{u as W,o as y,_ as ce,$ as ue,a0 as me,a1 as pe,a2 as he,a3 as xe,a4 as ge,a5 as be,a6 as ye,j as ke,V as ve,M as fe,K as je,a7 as we,a8 as _e,a9 as Ne,aa as Ce,ab as De,ac as Ie,B as b,ad as Se,f as Te,H as Ae,ae as Le,af as Be,S as D,p as Me}from"./main-6ldnj5-x.js";import{u as Ee}from"./i18n-DtNEmpUV.js";import{E as Oe}from"./ErrorMessage-BZq2Mfc5.js";import{M as Re}from"./Modal-Ct_jd6hP.js";import{I as q}from"./Input-B-mYP_qG.js";import"./vendor-BuZIrZAX.js";const m=({onClick:c,isActive:g,disabled:h,children:k,title:t})=>e.jsx("button",{type:"button",onClick:c,disabled:h,title:t,className:y("p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300",g&&"bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300",h&&"opacity-50 cursor-not-allowed"),children:k}),ze=({value:c,onChange:g,placeholder:h="Write something...",className:k,editable:t=!0})=>{const{t:i}=W(),w=M.useMemo(()=>[re.configure({link:!1}),oe.configure({placeholder:h}),le.configure({openOnClick:!1,linkOnPaste:!0})],[h]),s=ne({extensions:w,content:c,editable:t,onUpdate:M.useCallback(({editor:d})=>{g(d.getHTML())},[g]),editorProps:M.useMemo(()=>({attributes:{class:y("prose prose-sm dark:prose-invert max-w-none focus:outline-none min-h-[150px] px-3 py-2","prose-p:my-1 prose-headings:my-2 prose-ul:my-1 prose-ol:my-1 prose-li:my-0",!t&&"min-h-0")}}),[t])});if(n.useEffect(()=>{if(s&&c!==s.getHTML()){if(s.getText()===""&&c==="")return;s.isEmpty&&c&&s.commands.setContent(c)}},[s,c]),!s)return null;const r=()=>{const d=s.getAttributes("link").href,v=window.prompt("URL",d);if(v!==null){if(v===""){s.chain().focus().extendMarkRange("link").unsetLink().run();return}s.chain().focus().extendMarkRange("link").setLink({href:v}).run()}};return e.jsxs("div",{className:y("border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800 transition-colors focus-within:ring-2 focus-within:ring-blue-500/50",k),children:[t&&e.jsxs("div",{className:"flex flex-wrap items-center gap-1 p-1 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-900/30",children:[e.jsx(m,{onClick:()=>s.chain().focus().toggleBold().run(),isActive:s.isActive("bold"),title:i("rich_text.bold"),children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleItalic().run(),isActive:s.isActive("italic"),title:i("rich_text.italic"),children:e.jsx(ue,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"}),e.jsx(m,{onClick:()=>s.chain().focus().toggleHeading({level:1}).run(),isActive:s.isActive("heading",{level:1}),title:i("rich_text.heading"),children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleBulletList().run(),isActive:s.isActive("bulletList"),title:i("rich_text.bullet_list"),children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleOrderedList().run(),isActive:s.isActive("orderedList"),title:i("rich_text.ordered_list"),children:e.jsx(he,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleTaskList().run(),isActive:s.isActive("taskList"),title:i("rich_text.task_list"),disabled:!0,children:e.jsx(xe,{className:"w-4 h-4 opacity-50"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"}),e.jsx(m,{onClick:r,isActive:s.isActive("link"),title:i("rich_text.link"),children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleCodeBlock().run(),isActive:s.isActive("codeBlock"),title:i("rich_text.code_block"),children:e.jsx(be,{className:"w-4 h-4"})}),e.jsx(m,{onClick:()=>s.chain().focus().toggleBlockquote().run(),isActive:s.isActive("blockquote"),title:i("rich_text.blockquote"),children:e.jsx(ye,{className:"w-4 h-4"})})]}),e.jsx(ie,{editor:s,className:"min-h-[150px]"})]})},U={TODO:"todo"},Ve=({isOpen:c,data:g,zIndex:h,overlayClassName:k})=>{const{t}=W(),{closeModal:i,openModal:w}=ke(),s=!!c,r=g||null,d=!(r!=null&&r.id)||r.id.startsWith("temp-"),{projects:v}=ve(),{timeBlocks:$}=fe(),{customDurations:V}=Ee(),[_,E]=n.useState(""),[I,O]=n.useState(""),[N,R]=n.useState(null),[z,Q]=n.useState(U.TODO),[x,K]=n.useState(!1),[f,S]=n.useState(null),[o,T]=n.useState({type:"none",days:[]}),[A,P]=n.useState(null),[L,F]=n.useState(null),[C,H]=n.useState(!1),X=n.useMemo(()=>[{value:"none",label:t("recurrence.none")},{value:"daily",label:t("recurrence.daily")},{value:"weekdays",label:t("recurrence.weekdays")},{value:"weekly",label:t("recurrence.weekly")},{value:"monthly",label:t("recurrence.monthly")}],[t]),G=n.useMemo(()=>[t("days.sun"),t("days.mon"),t("days.tue"),t("days.wed"),t("days.thu"),t("days.fri"),t("days.sat")],[t]),[J,j]=n.useState(null);n.useEffect(()=>{if(r){E(r.title||""),O(r.description||""),R(r.projectId||null),Q(r.status||U.TODO),K(!!r.isImportant),P(r.timeBlockId||null),F(r.duration||null);const a=je(r.dueDate);S(a);const l=r.recurrence||{type:"none",days:[]};T(l),l!=null&&l.type&&l.type!=="none"&&!a&&S(we(l));const u=!!(a||(l==null?void 0:l.type)!=="none"||r.timeBlockId||r.duration);H(u||d)}},[r,s]);const B=n.useCallback(async()=>{j(null);const a={title:_.trim(),recurrence:(o==null?void 0:o.type)==="none"?null:o},l=_e(Ne.pick({title:!0,recurrence:!0}),a,!1);if(!l.success){j(l.errorMessage||t("validation.validation_error"));return}const u={title:_.trim(),description:I.trim()??null,projectId:N==="none"?null:N,status:z,isImportant:x,dueDate:f?de.fromDate(f):null,recurrence:(o==null?void 0:o.type)==="none"?null:o,timeBlockId:A??null,duration:L??void 0};try{d?await Ce(u):await De(r.id,u),i()}catch(p){console.error("Failed to save task",p),j(t("validation.save_fail"))}},[_,I,N,z,x,f,o,A,L,d,r,i,t]),Y=n.useCallback(async a=>{a==null||a.preventDefault(),a==null||a.stopPropagation(),j(null),!(!(r!=null&&r.id)||d)&&w("confirmation",{title:t("delete"),message:t("modal.delete_confirm"),confirmLabel:t("delete"),variant:"danger",onConfirm:async()=>{try{await Ie(r.id),i()}catch(l){console.error("Failed to delete task",l),j(t("validation.delete_fail"))}}})},[r==null?void 0:r.id,d,i,w,t]),Z=n.useCallback(a=>{let l=[];a==="weekly"?l=(o==null?void 0:o.days)||[]:a==="weekdays"&&(l=[1,2,3,4,5]),T({type:a,days:l})},[o==null?void 0:o.days]),ee=n.useCallback(a=>{const l=(o==null?void 0:o.days)||[],u=l.includes(a)?l.filter(p=>p!==a):[...l,a].sort((p,se)=>p-se);T({type:"weekly",days:u})},[o==null?void 0:o.days]),ae=a=>{a.key==="Enter"&&!a.nativeEvent.isComposing&&(a.preventDefault(),B())},te=a=>{(a.metaKey||a.ctrlKey)&&a.key==="Enter"&&(a.preventDefault(),B())};return s?e.jsx(Re,{isOpen:s,onClose:i,zIndex:h,size:"xl",className:"h-[95vh] sm:h-[85vh] w-full mx-2 sm:mx-auto mt-4 sm:mt-0 pb-safe",overlayClassName:k,children:e.jsxs("div",{className:"flex flex-col h-full",onKeyDown:te,children:[e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-b border-gray-100 dark:border-gray-700 flex items-center gap-2 shrink-0",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(q,{id:"task-title",name:"title",type:"text",value:_,onChange:a=>E(a.target.value),onKeyDown:ae,placeholder:t("task_detail.title_placeholder"),className:"text-base sm:text-lg font-semibold bg-transparent border-none focus:ring-0 px-0 py-0 shadow-none h-auto rounded-none",containerClassName:"gap-0",autoFocus:!0,"aria-label":t("task_detail.title_placeholder"),maxLength:15})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>K(!x),className:y("p-1.5 rounded-md transition-colors",x?"text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/30":"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"),title:t(x?"task_detail.unmark_important":"task_detail.mark_important"),"aria-label":t(x?"task_detail.unmark_important":"task_detail.mark_important"),children:e.jsx(Se,{size:16,fill:x?"currentColor":"none"})}),e.jsx(b,{variant:"ghost",size:"icon",onClick:i,className:"p-1.5 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors","aria-label":t("modal.close"),children:e.jsx(Te,{size:16})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar",children:[e.jsx(Oe,{message:J,className:"mb-3"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-6 h-full",children:[e.jsx("div",{className:"md:col-span-8 flex flex-col h-full min-h-[400px]",children:e.jsx(ze,{value:I,onChange:O,placeholder:t("task_detail.description_placeholder")||"詳細を追加...",className:"flex-1 flex flex-col"},(r==null?void 0:r.id)||"new")}),e.jsx("div",{className:"hidden md:block col-span-1 w-px bg-gray-100 dark:bg-gray-800 h-full mx-auto"}),e.jsxs("div",{className:"md:col-span-3 space-y-5 pt-1 overflow-y-auto no-scrollbar",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{type:"button",onClick:()=>H(!C),"aria-expanded":C,className:"w-full flex items-center justify-between group text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800 hover:text-blue-500 transition-colors focus:outline-none focus:border-blue-500",children:[e.jsx("span",{className:"flex items-center gap-2",children:t("task_detail.schedule_label")}),e.jsx(Ae,{className:y("w-3 h-3 transition-transform duration-200",C?"rotate-180":"")})]}),C&&e.jsxs("div",{className:"space-y-3 px-1 animate-in slide-in-from-top-1 fade-in duration-200",children:[e.jsx("div",{className:"relative group",children:e.jsx("div",{className:"relative cursor-pointer",onClick:()=>{var l;const a=document.getElementById("task-due-date");(l=a==null?void 0:a.showPicker)==null||l.call(a)},children:e.jsx(q,{type:"date",id:"task-due-date",label:t("task_detail.due_date_label"),value:f?Le(f):"",onChange:a=>S(Be(a.target.value)),className:"cursor-pointer bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto w-full"})})}),e.jsx("div",{children:e.jsx(D,{id:"task-recurrence",label:t("task_detail.recurrence_label"),value:(o==null?void 0:o.type)||"none",onChange:a=>Z(a.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",options:X})}),((o==null?void 0:o.type)==="weekly"||(o==null?void 0:o.type)==="weekdays")&&e.jsx("div",{className:"pt-2 animate-in fade-in slide-in-from-top-1 duration-200",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:G.map((a,l)=>{var p;const u=(p=o.days)==null?void 0:p.includes(l);return e.jsx(b,{type:"button",variant:u?"primary":"outline",size:"icon",onClick:()=>ee(l),className:y("w-7 h-7 text-xs rounded-full p-0 border",!u&&"bg-transparent text-gray-500 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:a},l)})})}),e.jsx("div",{children:e.jsxs(D,{id:"task-timeblock",label:t("task_detail.time_block_label"),value:A||"",onChange:a=>P(a.target.value||null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:t("task_detail.time_block_unspecified")}),$.map(a=>e.jsxs("option",{value:a.id,children:[a.start," - ",a.end]},a.id))]})}),e.jsx("div",{children:e.jsxs(D,{id:"task-duration",label:t("task_detail.duration_label"),value:L||"",onChange:a=>F(a.target.value?parseInt(a.target.value,10):null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:t("task_detail.duration_none")}),V.map(a=>e.jsxs("option",{value:a,children:[a," ",t("task_detail.duration_unit")]},a))]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800",children:t("task_detail.project_label")}),e.jsx("div",{className:"px-1",children:e.jsxs(D,{id:"task-project",value:N||"none",onChange:a=>R(a.target.value==="none"?null:a.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",containerClassName:"gap-2",children:[e.jsx("option",{value:"none",children:t("task_detail.project_none")}),v.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})})]})]})]})]}),e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center shrink-0",children:[d?e.jsx("div",{}):e.jsx(b,{variant:"ghost",size:"sm",onClick:Y,className:"text-gray-400 hover:text-red-500 font-medium px-2",leftIcon:e.jsx(Me,{size:14}),children:t("task_detail.delete_button")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:i,className:"font-medium",children:t("modal.cancel")}),e.jsx(b,{variant:"primary",size:"sm",onClick:B,children:t(d?"modal.create":"modal.save")})]})]})]})}):null};export{Ve as TaskDetailModal};
