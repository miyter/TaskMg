import{r as o,j as e}from"./react-vendor-D2I7O6xs.js";import{T as ne}from"./firebase-Dk4oNdYC.js";import{u as ie,a as de,z as ce,A as ue,H as me,J as xe,K as pe,L as he,M as ge,I as U,B as x,f as W,N as be,O as ye,P as ve,Q as fe,R as ke,S as je,T as Ne,V as we,W as _e,X as Ce,Y as De,Z as D,g as Ie}from"./main-DFIaXETY.js";import{u as Te}from"./i18n-CkMKOdEg.js";import{E as Se}from"./ErrorMessage-ysv-5oYb.js";import{M as ze}from"./Modal-D4Lhsglk.js";import"./vendor-CBsUEP5T.js";import"./dnd-BYudv-0e.js";const Me={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function Ee(h){return h.replace(/[&<>"']/g,g=>Me[g]||g)}function $e(h){if(!h)return"";const g=h.split(`
`);let u=[],d=null;return g.forEach(s=>{const c=s.trimStart(),j=c.startsWith("* ")||c.startsWith("- "),b=/^\d+\.\s/.test(c),a=j||b;if(a){const n=b?"ol":"ul";if(d!==n){d&&u.push(`</${d}>`);const p=b?"list-decimal":"list-disc";u.push(`<${n} class="${p} ml-5 space-y-1">`),d=n}}else d&&(u.push(`</${d}>`),d=null);if(a){let n="";j?n=c.substring(2):n=c.replace(/^\d+\.\s/,"");const p=L(n);u.push(`<li>${p}</li>`)}else if(s.trim()){const n=s.match(/^(#{1,6})\s+(.+)$/);if(n){const p=n[1].length,I=L(n[2]),T={1:"text-2xl font-bold mb-3",2:"text-xl font-bold mb-2",3:"text-lg font-semibold mb-2",4:"text-base font-semibold mb-1",5:"text-sm font-semibold mb-1",6:"text-xs font-semibold mb-1"};u.push(`<h${p} class="${T[p]}">${I}</h${p}>`)}else u.push(`<p class="mb-2">${L(s)}</p>`)}else d&&(u.push(`</${d}>`),d=null)}),d&&u.push(`</${d}>`),u.join(`
`)}function L(h){return Ee(h).replace(/\[(.*?)\]\((.*?)\)/g,(u,d,s)=>`<a href="${s.replace(/"/g,"&quot;")}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline font-medium">${d}</a>`)}const q={TODO:"todo"},We=({isOpen:h,data:g,zIndex:u,overlayClassName:d})=>{const{t:s}=ie(),{closeModal:c,openModal:j}=de(),b=!!h,a=g,n=!(a!=null&&a.id)||a.id.startsWith("temp-"),{projects:p}=ce(),{timeBlocks:I}=ue(),{customDurations:T}=Te(),[w,P]=o.useState(""),[y,S]=o.useState(""),[_,H]=o.useState(null),[K,Q]=o.useState(q.TODO),[v,R]=o.useState(!1),[C,z]=o.useState(null),[r,M]=o.useState({type:"none",days:[]}),[E,A]=o.useState(null),[$,F]=o.useState(null),[Oe,X]=o.useState(!1),[Be,J]=o.useState(!1),V=o.useMemo(()=>[{value:"none",label:s("recurrence.none")},{value:"daily",label:s("recurrence.daily")},{value:"weekdays",label:s("recurrence.weekdays")},{value:"weekly",label:s("recurrence.weekly")},{value:"monthly",label:s("recurrence.monthly")}],[s]),Y=o.useMemo(()=>[s("days.sun"),s("days.mon"),s("days.tue"),s("days.wed"),s("days.thu"),s("days.fri"),s("days.sat")],[s]),[Z,f]=o.useState(null);o.useEffect(()=>{var t;if(a){P(a.title||""),S(a.description||""),H(a.projectId||null),Q(a.status||q.TODO),R(!!a.isImportant),A(a.timeBlockId||null),F(a.duration||null);const l=me(a.dueDate);z(l);const i=a.recurrence||{type:"none",days:[]};M(i),i!=null&&i.type&&i.type!=="none"&&!l&&z(xe(i));const m=!!(l||(i==null?void 0:i.type)!=="none"||a.timeBlockId||a.duration);J(m||n),X(!!((t=a.description)!=null&&t.trim()))}},[a,b]);const O=o.useCallback(async()=>{if(f(null),!w.trim()){f(s("validation.required"));return}if((r==null?void 0:r.type)==="weekly"&&(!r.days||r.days.length===0)){f(s("validation.select_days"));return}const t={title:w.trim(),description:y.trim()??null,projectId:_==="none"?null:_,status:K,isImportant:v,dueDate:C?ne.fromDate(C):null,recurrence:(r==null?void 0:r.type)==="none"?null:r,timeBlockId:E??null,duration:$??void 0};try{n?await pe(t):await he(a.id,t),c()}catch(l){console.error("Failed to save task",l),f(s("validation.save_fail"))}},[w,y,_,K,v,C,r,E,$,n,a,c,s]),G=o.useCallback(async t=>{t==null||t.preventDefault(),t==null||t.stopPropagation(),f(null),!(!(a!=null&&a.id)||n)&&(!(a!=null&&a.id)||n||j("confirmation",{title:s("delete"),message:s("modal.delete_confirm"),confirmLabel:s("delete"),variant:"danger",onConfirm:async()=>{try{await ge(a.id),c()}catch(l){console.error("Failed to delete task",l),f(s("validation.delete_fail"))}}}))},[a==null?void 0:a.id,n,c,j,s]),ee=o.useCallback(t=>{let l=[];t==="weekly"?l=(r==null?void 0:r.days)||[]:t==="weekdays"&&(l=[1,2,3,4,5]),M({type:t,days:l})},[r==null?void 0:r.days]),te=o.useCallback(t=>{const l=(r==null?void 0:r.days)||[],i=l.includes(t)?l.filter(m=>m!==t):[...l,t].sort((m,N)=>m-N);M({type:"weekly",days:i})},[r==null?void 0:r.days]),se=o.useMemo(()=>$e(y),[y]),ae=t=>{t.key==="Enter"&&!t.nativeEvent.isComposing&&(t.preventDefault(),O())},re=t=>{(t.metaKey||t.ctrlKey)&&t.key==="Enter"&&(t.preventDefault(),O())},k=o.useCallback((t,l="")=>{const i=document.getElementById("task-description");if(!i)return;const m=i.selectionStart,N=i.selectionEnd,B=i.value,le=B.substring(m,N),oe=B.substring(0,m)+t+le+l+B.substring(N);S(oe),setTimeout(()=>{i.focus(),i.setSelectionRange(m+t.length,N+t.length)},0)},[]);return b?e.jsx(ze,{isOpen:b,onClose:c,zIndex:u,size:"xl",className:"h-[95vh] sm:h-[85vh] w-full mx-2 sm:mx-auto mt-4 sm:mt-0 pb-safe",overlayClassName:d,children:e.jsxs("div",{className:"flex flex-col h-full",onKeyDown:re,children:[e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-b border-gray-100 dark:border-gray-700 flex items-center gap-2 shrink-0",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(U,{id:"task-title",name:"title",type:"text",value:w,onChange:t=>P(t.target.value),onKeyDown:ae,placeholder:s("task_detail.title_placeholder"),className:"text-base sm:text-lg font-semibold bg-transparent border-none focus:ring-0 px-0 py-0 shadow-none h-auto rounded-none",containerClassName:"gap-0",autoFocus:!0,"aria-label":s("task_detail.title_placeholder")})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>R(!v),className:W("p-1.5 rounded-md transition-colors",v?"text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/30":"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"),title:v?"重要度を解除":"重要としてマーク",children:e.jsx(be,{size:16,fill:v?"currentColor":"none"})}),e.jsx(x,{variant:"ghost",size:"icon",onClick:c,className:"p-1.5 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors","aria-label":"閉じる",children:e.jsx(ye,{size:16})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar",children:[e.jsx(Se,{message:Z,className:"mb-3"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-6 h-full",children:[e.jsxs("div",{className:"md:col-span-8 flex flex-col h-full min-h-[400px]",children:[e.jsxs("div",{className:"flex items-center gap-0.5 mb-2 pb-1.5 border-b border-gray-100 dark:border-gray-800 shrink-0 overflow-x-auto no-scrollbar",children:[e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("**","**"),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"Bold",children:e.jsx(ve,{size:16})}),e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("*","*"),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"Italic",children:e.jsx(fe,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1.5"}),e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("- "),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"List",children:e.jsx(ke,{size:16})}),e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("1. "),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"Numbered List",children:e.jsx(je,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1.5"}),e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("### "),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"Heading",children:e.jsx(Ne,{size:16})}),e.jsx(x,{variant:"ghost",size:"icon",type:"button",onClick:()=>k("> "),className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500",title:"Quote",children:e.jsx(we,{size:16})}),e.jsx("div",{className:"flex-1"})]}),e.jsxs("div",{className:"flex-1 flex flex-col md:flex-row gap-4 h-full min-h-0",children:[e.jsxs("div",{className:"flex-1 flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 px-0.5",children:"Editor"}),e.jsx(_e,{id:"task-description",name:"description",value:y,onChange:t=>S(t.target.value),placeholder:"Add details...",className:"flex-1 bg-transparent border-0 focus:ring-0 p-0 text-gray-800 dark:text-gray-200 font-mono text-xs sm:text-sm resize-none leading-relaxed custom-scrollbar",containerClassName:"h-full",autoFocus:!y,"aria-label":"Description"})]}),e.jsx("div",{className:"hidden md:block w-px bg-gray-100 dark:bg-gray-800 self-stretch my-2"}),e.jsxs("div",{className:"flex-1 flex flex-col h-full min-h-0 border-t md:border-t-0 pt-4 md:pt-0",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 px-0.5",children:"Preview"}),e.jsx("div",{className:"flex-1 py-0 pr-2 text-xs sm:text-sm overflow-y-auto custom-scrollbar prose prose-sm dark:prose-invert max-w-none prose-p:my-1 prose-headings:my-2 prose-ul:my-1 prose-li:my-0.5",dangerouslySetInnerHTML:{__html:se||'<span class="text-gray-400 italic">No content</span>'}})]})]})]}),e.jsx("div",{className:"hidden md:block col-span-1 w-px bg-gray-100 dark:bg-gray-800 h-full mx-auto"}),e.jsxs("div",{className:"md:col-span-3 space-y-5 pt-1 overflow-y-auto no-scrollbar",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800",children:s("task_detail.schedule_label")}),e.jsxs("div",{className:"space-y-3 px-1",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:s("task_detail.due_date_label")}),e.jsx("div",{className:"relative cursor-pointer",onClick:()=>{var l;const t=document.getElementById("task-due-date");(l=t==null?void 0:t.showPicker)==null||l.call(t)},children:e.jsx(U,{type:"date",id:"task-due-date",value:Ce(C),onChange:t=>z(De(t.target.value)),className:"cursor-pointer bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto w-full"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:s("task_detail.recurrence_label")}),e.jsx(D,{id:"task-recurrence",value:(r==null?void 0:r.type)||"none",onChange:t=>ee(t.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",options:V})]}),((r==null?void 0:r.type)==="weekly"||(r==null?void 0:r.type)==="weekdays")&&e.jsx("div",{className:"pt-2 animate-in fade-in slide-in-from-top-1 duration-200",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:Y.map((t,l)=>{var m;const i=(m=r.days)==null?void 0:m.includes(l);return e.jsx("button",{type:"button",onClick:()=>te(l),className:W("w-7 h-7 rounded-full text-xs flex items-center justify-center transition-colors border",i?"bg-blue-500 text-white border-blue-500":"bg-transparent text-gray-500 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:t},l)})})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:s("task_detail.time_block_label")}),e.jsxs(D,{id:"task-timeblock",value:E||"",onChange:t=>A(t.target.value||null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:s("task_detail.time_block_unspecified")}),I.map(t=>e.jsxs("option",{value:t.id,children:[t.start," - ",t.end]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:s("task_detail.duration_label")}),e.jsxs(D,{id:"task-duration",value:$||"",onChange:t=>F(t.target.value?parseInt(t.target.value,10):null),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",children:[e.jsx("option",{value:"",children:s("task_detail.duration_none")}),T.map(t=>e.jsxs("option",{value:t,children:[t," ",s("task_detail.duration_unit")]},t))]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest pb-1 border-b border-gray-100 dark:border-gray-800",children:s("task_detail.project_label")}),e.jsx("div",{className:"px-1",children:e.jsxs(D,{id:"task-project",value:_||"none",onChange:t=>H(t.target.value==="none"?null:t.target.value),className:"bg-transparent border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors text-sm rounded px-2 py-1.5 h-auto",containerClassName:"gap-2",children:[e.jsx("option",{value:"none",children:s("task_detail.project_none")}),p.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})})]})]})]})]}),e.jsxs("div",{className:"px-3 sm:px-4 py-2 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center shrink-0",children:[n?e.jsx("div",{}):e.jsx(x,{variant:"ghost",size:"sm",onClick:G,className:"text-gray-400 hover:text-red-500 font-medium px-2",leftIcon:e.jsx(Ie,{size:14}),children:s("task_detail.delete_button")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:c,className:"font-medium",children:s("modal.cancel")}),e.jsx(x,{variant:"primary",size:"sm",onClick:O,children:s(n?"modal.create":"modal.save")})]})]})]})}):null};export{We as TaskDetailModal};
