import{i as G,d as w,F as W,G as B,j as e,H as q,I as J,S as Y,J as Q,K as ee,L as te,M as re,N as ae,P as se,c as C}from"./vendor-j1jwJuCp.js";import{u as R,j as ne,M as oe,k as le,ag as ie,U as j,B as S,ah as ce,ai as de,C as E,o as O,p as ge,aj as me,ak as ue,H as xe}from"./main-DP3x7AFG.js";import"./i18n-DnoxxtLm.js";import"./firebase-CTDNBn9D.js";import{E as fe}from"./ErrorMessage-B01ntcHN.js";import{M as he}from"./Modal-C8UH6Z5J.js";const L=({children:n,containerId:x="portal-root"})=>{const u=document.getElementById(x)??document.body;return G.createPortal(n,u)},T=Array.from({length:24},(n,x)=>String(x).padStart(2,"0")).map(n=>({value:n,label:n})),$=["00","15","30","45"].map(n=>({value:n,label:n})),je=({isOpen:n,zIndex:x,overlayClassName:u})=>{const{t:i}=R(),{closeModal:c,openModal:p}=ne(),g=!!n,{timeBlocks:v}=oe(),{workspaceId:k}=le(),[s,d]=w.useState([]),[N,b]=w.useState(!1),[t,f]=w.useState(null),[I,P]=w.useState(null),A=W(B(se,{activationConstraint:{distance:5}}),B(ae,{coordinateGetter:re}));w.useEffect(()=>{g&&(d(v.sort((r,o)=>(r.order||0)-(o.order||0))),f(null),b(!1))},[g,v]);const z=()=>{if(s.length>=j.TIME_BLOCK.MAX_COUNT)return;let r="09:00",o="10:00";if(s.length>0){const l=s[s.length-1];if(l.end){const[m,h]=l.end.split(":").map(Number);r=l.end;const y=(m+1)%24;o=`${String(y).padStart(2,"0")}:${String(h).padStart(2,"0")}`}}const a={id:`new-${Date.now()}`,start:r,end:o,color:E[s.length%E.length].value,order:s.length};d([...s,a])},K=async r=>{if(!r.startsWith("new-")){p("confirmation",{title:i("delete"),message:i("time_block.delete_confirm"),confirmLabel:i("delete"),variant:"danger",onConfirm:async()=>{try{k&&(await me(k,r),d(o=>o.filter(a=>a.id!==r)))}catch{f(i("validation.delete_fail"))}}});return}d(s.filter(o=>o.id!==r))},X=(r,o)=>{d(s.map(a=>a.id===r?{...a,...o}:a))},U=r=>{P(r.active.id)},H=r=>{const{active:o,over:a}=r;P(null),a&&o.id!==a.id&&d(l=>{const m=l.findIndex(y=>y.id===o.id),h=l.findIndex(y=>y.id===a.id);return te(l,m,h)})},V=async()=>{b(!0),f(null);try{for(const a of s){if(!a.start||!a.end)continue;const[l,m]=a.start.split(":").map(Number),[h,y]=a.end.split(":").map(Number);if(l*60+m>=h*60+y)throw new Error(i("time_block.error_invalid_time",{start:a.start,end:a.end}))}const r=[...s].sort((a,l)=>(a.start||"").localeCompare(l.start||""));for(let a=0;a<r.length-1;a++){const l=r[a],m=r[a+1];if(!l.end||!m.start)continue;const[h,y]=l.end.split(":").map(Number),[F,Z]=m.start.split(":").map(Number);if(F*60+Z<h*60+y)throw new Error(i("time_block.error_overlap",{range1:`${l.start}-${l.end}`,range2:`${m.start}-${m.end}`}))}const o=s.map((a,l)=>{var h;const m={...a,id:(h=a.id)!=null&&h.startsWith("new-")?null:a.id,order:l,name:`${a.start}-${a.end}`};if(!k)throw new Error("No workspace");return ue(k,m)});await Promise.all(o),await Promise.all(o),c()}catch(r){const o=r instanceof Error?r.message:String(r);f(o||i("validation.save_fail")),b(!1)}};if(!g)return null;const D=I?s.find(r=>r.id===I):null;return e.jsx(he,{isOpen:g,onClose:c,title:i("time_block.settings_title"),size:"lg",className:"h-[600px]",zIndex:x,overlayClassName:u,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-3 custom-scrollbar",children:[e.jsxs(q,{sensors:A,collisionDetection:J,onDragStart:U,onDragEnd:H,children:[e.jsx(Y,{items:s.map(r=>r.id),strategy:Q,children:s.map(r=>e.jsx(ie,{id:r.id,children:e.jsx(M,{block:r,onDelete:()=>K(r.id),onUpdate:o=>X(r.id,o),isOverlay:!1})},r.id))}),e.jsx(ee,{dropAnimation:null,modifiers:[],children:D?e.jsx("div",{style:{opacity:.9},children:e.jsx(M,{block:D,onDelete:()=>{},onUpdate:()=>{},isOverlay:!0})}):null})]}),s.length<j.TIME_BLOCK.MAX_COUNT?e.jsx("div",{className:"flex justify-center py-2",children:e.jsx(S,{onClick:z,size:"icon",className:"w-10 h-10 rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center hover:scale-105 active:scale-95",title:i("time_block.add_button"),children:e.jsx(ce,{className:"w-5 h-5"})})}):e.jsxs("div",{className:"p-2 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 text-xs rounded-lg flex items-center justify-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),i("time_block.max_limit")]})]}),e.jsx(fe,{message:t,className:"mb-4"}),e.jsx("div",{className:"pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-end",children:e.jsx(S,{type:"button",onClick:V,isLoading:N,className:"px-6",children:i("done")})})]})})},_=({value:n,options:x,onChange:u,className:i,ariaLabel:c})=>{var b;const[p,g]=w.useState(!1),[v,k]=w.useState({top:0,left:0,width:0}),s=C.useRef(null),d=C.useRef(null),N=t=>{if(t.stopPropagation(),t.preventDefault(),s.current){const f=s.current.getBoundingClientRect();k({top:f.bottom+window.scrollY+4,left:f.left+window.scrollX,width:f.width}),g(!p)}};return C.useEffect(()=>{if(p&&d.current){const t=d.current.querySelector('[data-selected="true"]');t&&t.scrollIntoView({block:"center"})}},[p]),e.jsxs(e.Fragment,{children:[e.jsxs("button",{ref:s,onClick:N,className:O("flex items-center justify-between bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-md px-2 text-left transition-colors text-sm font-medium",i),"aria-label":c,type:"button",onPointerDown:t=>t.stopPropagation(),children:[e.jsx("span",{className:"truncate",children:((b=x.find(t=>t.value===n))==null?void 0:b.label)||n}),e.jsx(xe,{className:"w-3 h-3 text-gray-400 shrink-0 ml-1 opacity-50"})]}),p&&e.jsxs(L,{children:[e.jsx("div",{className:"fixed inset-0 bg-transparent",style:{zIndex:j.Z_INDEX.POPOVER_BACKDROP},onClick:t=>{t.stopPropagation(),g(!1)}}),e.jsx("div",{ref:d,className:"fixed bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-xl overflow-y-auto custom-scrollbar flex flex-col py-1 animate-in fade-in zoom-in-95 duration-100",style:{zIndex:j.Z_INDEX.POPOVER,top:v.top,left:v.left,width:Math.max(v.width,60),maxHeight:"180px"},children:x.map(t=>e.jsx("button",{"data-selected":t.value===n,onClick:f=>{f.stopPropagation(),u(t.value),g(!1)},className:O("px-3 py-1.5 text-left text-sm hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors w-full font-mono",t.value===n?"text-blue-600 dark:text-blue-400 font-bold":"text-gray-700 dark:text-gray-200"),children:t.label},t.value))})]})]})},M=({block:n,onDelete:x,onUpdate:u,isOverlay:i})=>{const{t:c}=R(),[p,g]=w.useState(!1),v=n.start||"09:00",k=n.end||"10:00",[s,d]=v.split(":"),[N,b]=k.split(":");return e.jsxs("div",{className:`flex items-center gap-4 p-3 rounded-lg group transition-colors hover:bg-gray-50 dark:hover:bg-gray-800/50 ${i?"bg-white dark:bg-gray-800 shadow-xl ring-1 ring-black/5":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>g(!p),className:"w-5 h-5 rounded-full shadow-sm ring-2 ring-transparent focus:ring-blue-400 ring-offset-2 dark:ring-offset-gray-900 block transition-transform hover:scale-110",style:{backgroundColor:n.color||j.DEFAULT_COLORS.TIME_BLOCK},title:c("time_block.change_color"),onPointerDown:t=>t.stopPropagation()}),p&&e.jsxs(L,{children:[e.jsx("div",{className:"fixed inset-0 bg-transparent",style:{zIndex:j.Z_INDEX.POPOVER_BACKDROP},onClick:()=>g(!1)}),e.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 w-[280px]",style:{zIndex:j.Z_INDEX.POPOVER,top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 dark:text-gray-500 uppercase mb-3 tracking-wider",children:c("modal.theme_color")}),e.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:E.map(t=>e.jsx("button",{onClick:()=>{u({color:t.value}),g(!1)},className:O("w-8 h-8 rounded-full ring-2 ring-transparent hover:ring-blue-400 focus:outline-none transition-transform hover:scale-110",n.color===t.value&&"ring-2 ring-offset-2 ring-blue-500 dark:ring-offset-gray-800"),style:{backgroundColor:t.value},"aria-label":c(`colors.${t.key}`),"aria-pressed":n.color===t.value},t.value))})]})]})]}),e.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1 bg-gray-50 dark:bg-gray-800/50 rounded-lg p-1",children:[e.jsx(_,{options:T,value:s,onChange:t=>u({start:`${t}:${d}`}),className:"w-[50px] justify-center bg-transparent border-none hover:bg-gray-200 dark:hover:bg-gray-700",ariaLabel:c("time_block.time_select")}),e.jsx("span",{className:"text-gray-300 dark:text-gray-600 font-mono",children:":"}),e.jsx(_,{options:$,value:d,onChange:t=>u({start:`${s}:${t}`}),className:"w-[50px] justify-center bg-transparent border-none hover:bg-gray-200 dark:hover:bg-gray-700",ariaLabel:c("time_block.time_select")})]}),e.jsx("div",{className:"w-6 h-px bg-gray-200 dark:bg-gray-700"}),e.jsxs("div",{className:"flex items-center gap-1 bg-gray-50 dark:bg-gray-800/50 rounded-lg p-1",children:[e.jsx(_,{options:T,value:N,onChange:t=>u({end:`${t}:${b}`}),className:"w-[50px] justify-center bg-transparent border-none hover:bg-gray-200 dark:hover:bg-gray-700",ariaLabel:c("time_block.time_select")}),e.jsx("span",{className:"text-gray-300 dark:text-gray-600 font-mono",children:":"}),e.jsx(_,{options:$,value:b,onChange:t=>u({end:`${N}:${t}`}),className:"w-[50px] justify-center bg-transparent border-none hover:bg-gray-200 dark:hover:bg-gray-700",ariaLabel:c("time_block.time_select")})]})]}),e.jsx(S,{onClick:x,variant:"ghost",size:"icon",className:"text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 opacity-0 group-hover:opacity-100 transition-opacity",title:c("modal.delete"),onPointerDown:t=>t.stopPropagation(),children:e.jsx(ge,{className:"w-4 h-4"})})]})};export{je as TimeBlockEditModal};
